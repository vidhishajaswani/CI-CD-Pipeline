---
- hosts: localhost
  become: yes
  vars_files:
    - /var/lib/jenkins/variables.yml
  tasks:
    
    - name: db.properties
      copy:
        src: "{{ itrust_repo }}/iTrust2/iTrust2/src/main/java/db.properties.template"
        dest: "{{ itrust_repo }}/iTrust2/iTrust2/src/main/java/db.properties"
        remote_src: yes

    - name: email.properties
      copy:                                     
        src: /var/lib/jenkins/email.properties
        dest: "{{ itrust_repo }}/iTrust2/iTrust2/src/main/java/email.properties"
        remote_src: yes
        

    - name: Edit mysql.conf file
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        line: skip-grant-tables
        insertafter: skip-external-locking

    - name: Restarting mysql service
      service:
        name: mysql
        state: restarted
        
    - name: enabling access to mvn
      lineinfile:
        path: /etc/sudoers
        line: "jenkins ALL=(ALL) NOPASSWD: ALL"
    
    - name: mvn clean
      command: mvn clean test checkstyle:checkstyle
      args:
        chdir: "{{ itrust_repo }}/iTrust2/iTrust2"

    - name: mvn test classes
      command: mvn process-test-classes
      args:
        chdir: "{{ itrust_repo }}/iTrust2/iTrust2"

    - name: Update apt
      apt: update_cache=yes


    - name: mvn checkstyle
      command: sh -c "mvn clean test checkstyle:checkstyle"
      args:
        chdir: "{{ itrust_repo }}/iTrust2/iTrust2"